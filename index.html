<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>å‹‰å¼·ã‚¿ã‚¤ãƒãƒ¼</title>

<style>
body {
  font-family: sans-serif;
  text-align: center;
  background: #0b1020;
  color: white;
}
input, button {
  font-size: 1rem;
  padding: 0.5rem;
  margin: 0.3rem;
}
button {
  cursor: pointer;
}
canvas {
  position: fixed;
  inset: 0;
  pointer-events: none;
}
</style>
</head>

<body>

<h1>ğŸ“š å‹‰å¼·ã‚¿ã‚¤ãƒãƒ¼</h1>

<div>
  <label>
    å‹‰å¼·æ™‚é–“ï¼ˆåˆ†ï¼‰
    <input type="number" id="minutes" value="25">
  </label>
</div>

<div>
  <label>
    é–‹å§‹æ™‚åˆ»
    <input type="datetime-local" id="startTime">
  </label>
</div>

<div>
  <button onclick="startTimer()">â–¶ é–‹å§‹</button>
  <button onclick="stopTimer()">â¹ çµ‚äº†</button>
  <button onclick="addToCalendar()">ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç™»éŒ²</button>
</div>

<h2 id="status">å¾…æ©Ÿä¸­</h2>

<canvas id="fireworks"></canvas>

<script>
let timerId = null;
let endTime = null;

/* ---------- ã‚¿ã‚¤ãƒãƒ¼ ---------- */
function startTimer() {
  stopTimer(false); // äºŒé‡èµ·å‹•é˜²æ­¢

  const minutes = Number(document.getElementById("minutes").value);
  endTime = Date.now() + minutes * 60000;
  document.getElementById("status").textContent = "é›†ä¸­ä¸­â€¦";

  timerId = setInterval(() => {
    if (Date.now() >= endTime) {
      stopTimer(true);
    }
  }, 500);
}

function stopTimer(showFireworks = true) {
  if (timerId) {
    clearInterval(timerId);
    timerId = null;
  }
  document.getElementById("status").textContent = "çµ‚äº†ï¼";
  if (showFireworks) launchFireworks();
}

/* ---------- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ ---------- */
function addToCalendar() {
  const start = new Date(document.getElementById("startTime").value);
  const minutes = Number(document.getElementById("minutes").value);
  const end = new Date(start.getTime() + minutes * 60000);

  const ics =
`BEGIN:VCALENDAR
VERSION:2.0
BEGIN:VEVENT
DTSTART:${formatICS(start)}
DTEND:${formatICS(end)}
SUMMARY:å‹‰å¼·ã‚¿ã‚¤ãƒãƒ¼
DESCRIPTION:é›†ä¸­ã‚¿ã‚¤ãƒ 
END:VEVENT
END:VCALENDAR`;

  const blob = new Blob([ics], { type: "text/calendar" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "study_timer.ics";
  link.click();
}

function formatICS(date) {
  return date.toISOString().replace(/[-:]/g, "").split(".")[0] + "Z";
}

/* ---------- èŠ±ç« ---------- */
const canvas = document.getElementById("fireworks");
const ctx = canvas.getContext("2d");

resizeCanvas();
window.addEventListener("resize", resizeCanvas);

function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}

function launchFireworks() {
  let particles = [];

  for (let i = 0; i < 120; i++) {
    particles.push({
      x: canvas.width / 2,
      y: canvas.height / 2,
      vx: (Math.random() - 0.5) * 8,
      vy: (Math.random() - 0.5) * 8,
      life: 80,
      color: `hsl(${Math.random() * 360},100%,60%)`
    });
  }

  function animate() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    particles.forEach(p => {
      ctx.fillStyle = p.color;
      ctx.fillRect(p.x, p.y, 4, 4);
      p.x += p.vx;
      p.y += p.vy;
      p.life--;
    });
    particles = particles.filter(p => p.life > 0);
    if (particles.length > 0) requestAnimationFrame(animate);
  }

  animate();
}
</script>

</body>
</html>
